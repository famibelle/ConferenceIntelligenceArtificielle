<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Conférence IA — Slides</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/reveal.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/theme/black.css" id="theme" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="reveal">
    <div class="slides">
      <!-- Charge le Markdown; utilisez --- pour séparer les slides, -- pour les sous-slides -->
      <section data-markdown="ConférenceIA.md"
               data-separator="^---$"
               data-separator-vertical="^--$"
               data-separator-notes="^Note:">
      </section>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/reveal.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/markdown/markdown.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/highlight/highlight.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/notes/notes.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fitty@2/dist/fitty.min.js"></script>
  <script>
    Reveal.initialize({
      hash: true,
      slideNumber: true,
      center: false,
      plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ],
    });

    function attr(sec, name, defVal) {
      const v = sec.getAttribute(name);
      return (v === null || v === undefined || v === '') ? defVal : v;
    }

    // Convertit URL YouTube en embed
    function toYoutubeEmbed(url) {
      let embed = url;
      try {
        const u = new URL(url);
        if (u.hostname === 'youtu.be') {
          const id = u.pathname.replace('/', '');
          embed = `https://www.youtube.com/embed/${id}`;
        } else if (u.hostname.includes('youtube.com')) {
          if (u.pathname === '/watch') {
            const id = u.searchParams.get('v');
            if (id) embed = `https://www.youtube.com/embed/${id}`;
          } else if (u.pathname.startsWith('/embed/')) {
            embed = url;
          }
        }
      } catch (e) { }
      try {
        const eu = new URL(embed);
        eu.searchParams.set('autoplay', '1');
        eu.searchParams.set('mute', '1');
        eu.searchParams.set('playsinline', '1');
        return eu.toString();
      } catch (e) {
        return embed;
      }
    }

    // Layout deux colonnes avec texte dynamique
    function applyTwoColumnLayout() {
      const sections = document.querySelectorAll('section[data-layout="two-column"]');
      sections.forEach(sec => {
        if (sec.dataset.layoutApplied === '1') return;
        
        const imgSrc = attr(sec, 'data-img', '');
        const videoSrc = attr(sec, 'data-video', '');
        const alt = attr(sec, 'data-alt', 'Image');
        const side = attr(sec, 'data-side', 'right');
        
        // Extrait le titre
        const heading = sec.querySelector('h1, h2');
        let titleHTML = '';
        if (heading) {
          titleHTML = heading.outerHTML;
          heading.remove();
        }
        
        // Récupère le contenu texte
        const textHTML = sec.innerHTML;
        
        // Crée la structure
        const container = document.createElement('div');
        container.className = 'slide-container';
        
        // Div titre
        if (titleHTML) {
          const titleDiv = document.createElement('div');
          titleDiv.className = 'slide-title';
          titleDiv.innerHTML = titleHTML;
          container.appendChild(titleDiv);
        }
        
        // Div colonnes
        const columnsDiv = document.createElement('div');
        columnsDiv.className = 'slide-columns';
        
        // Colonne texte
        const textDiv = document.createElement('div');
        textDiv.className = 'slide-text';
        const textContent = document.createElement('div');
        textContent.className = 'slide-text-content';
        textContent.innerHTML = textHTML;
        textDiv.appendChild(textContent);
        
        // Colonne média
        const mediaDiv = document.createElement('div');
        mediaDiv.className = 'slide-media';
        
        if (videoSrc) {
          const videoWrapper = document.createElement('div');
          videoWrapper.className = 'video-wrapper';
          const iframe = document.createElement('iframe');
          iframe.src = toYoutubeEmbed(videoSrc);
          iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
          iframe.allowFullscreen = true;
          videoWrapper.appendChild(iframe);
          mediaDiv.appendChild(videoWrapper);
        } else if (imgSrc) {
          const img = document.createElement('img');
          img.src = imgSrc;
          img.alt = alt;
          mediaDiv.appendChild(img);
        }
        
        // Ordre des colonnes
        if (side === 'left') {
          columnsDiv.appendChild(mediaDiv);
          columnsDiv.appendChild(textDiv);
        } else {
          columnsDiv.appendChild(textDiv);
          columnsDiv.appendChild(mediaDiv);
        }
        
        container.appendChild(columnsDiv);
        
        // Remplace le contenu de la section
        sec.innerHTML = '';
        sec.appendChild(container);
        sec.dataset.layoutApplied = '1';
        
        // Applique le scaling du texte avec fitty
        applyFitty(textContent, textDiv);
      });
    }

    // Ajuste la taille du texte pour remplir la hauteur avec fitty.js
    function applyFitty(textContent, textContainer) {
      // Attend que le DOM soit rendu
      requestAnimationFrame(() => {
        setTimeout(() => {
          if (typeof fitty !== 'undefined') {
            const containerHeight = textContainer.getBoundingClientRect().height;
            
            // Applique fitty avec la hauteur max du conteneur
            fitty(textContent, {
              minSize: 12,
              maxSize: containerHeight,
              multiLine: true,
              observeMutations: {
                subtree: true,
                childList: true,
                characterData: true
              }
            });
          }
        }, 100);
      });
    }

    Reveal.on('ready', applyTwoColumnLayout);
    Reveal.on('slidechanged', () => {
      applyTwoColumnLayout();
      // Re-scale le texte après changement de slide
      setTimeout(() => {
        document.querySelectorAll('.slide-text-content').forEach(content => {
          const container = content.closest('.slide-text');
          if (container) {
            applyFitty(content, container);
          }
        });
      }, 100);
    });
    window.addEventListener('resize', () => {
      // Fitty gère automatiquement le resize avec observeMutations
    });
  </script>
</body>
</html>
